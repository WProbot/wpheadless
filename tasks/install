#!/usr/bin/env bash

set -eo pipefail

DOMAIN="${1:-localhost}"
ADMIN_EMAIL="$2"
ADMIN_PASSWORD="$3"
STAGE="${4:-development}"

if [ "$STAGE" = "production" ]; then
  touch .production
  export DOMAIN
else
  rm -f .production
fi

if [ -z "$ADMIN_EMAIL" ]; then
  if [ "$DOMAIN" = "localhost" ]; then
    ADMIN_EMAIL="webmaster@example.com"
  else
    ADMIN_EMAIL="webmaster@${DOMAIN}"
  fi
fi

./run-task configure "$DOMAIN" "$ADMIN_EMAIL"

if [ "$STAGE" = "production" ]; then
  ./run-task leissue-standalone || \
    ./run-task openssl-self-signed
else
  ./run-task openssl-self-signed
fi

./run-task openssl-dhparam
./docker-compose up -d
./run-task wp-install "$ADMIN_PASSWORD"
